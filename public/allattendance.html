<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Report</title>
  <script>
    // On page load, fetch semester attendance and subject/lecture info
    window.onload = async function () {
      try {
        // Fetch attendance summary, lecture counts, and subjects
        const [attendanceSummary, lecturesData, subjectsData] = await Promise.all([
          fetch('/node/users/attendance').then(res => res.json()),
          fetch('/node/lectures?start=2025-01-01&end=2025-03-24').then(res => res.json()),
          fetch('/node/subjects').then(res => res.json())
        ]);
  
        // Process semester attendance data:
        // For each student, compute percentage for each subject attended.
        let semesterData = [];
        attendanceSummary.users.forEach(user => {
          let studentRecord = { id: user._id, subjects: [] };
          user.subjects.forEach(sub => {
            // Get total lectures for the subject
            let totalLectures = lecturesData[sub.subject] || 0;
            let percent = totalLectures > 0 ? ((sub.count / totalLectures) * 100).toFixed(2) : "N/A";
            studentRecord.subjects.push({
              subject: sub.subject,
              count: sub.count,
              totalLectures: totalLectures,
              percent: percent
            });
          });
          semesterData.push(studentRecord);
        });
  
        // Build subject-wise mapping: for each subject, list student records.
        let subjectWise = {};
        // Initialize for every subject from the API
        subjectsData.subjects.forEach(subject => {
          subjectWise[subject] = [];
        });
        attendanceSummary.users.forEach(user => {
          user.subjects.forEach(sub => {
            let totalLectures = lecturesData[sub.subject] || 0;
            let percent = totalLectures > 0 ? ((sub.count / totalLectures) * 100).toFixed(2) : "N/A";
            subjectWise[sub.subject].push({
              id: user._id,
              count: sub.count,
              totalLectures: totalLectures,
              percent: percent
            });
          });
        });
  
        // Display the results in the respective sections.
        displaySemesterAttendance(semesterData);
        displaySubjectWiseAttendance(subjectWise);
  
      } catch (error) {
        console.error("Error fetching semester data:", error);
      }
    };
  
    // Function to fetch daily attendance for a given date (using a date input)
    async function fetchDailyAttendance() {
      const date = document.getElementById('dailyDate').value;
      try {
        const dailyResponse = await fetch('/node/users/attendance/' + date)
          .then(res => res.json());
        displayDailyAttendance(dailyResponse.users);
      } catch (error) {
        console.error("Error fetching daily attendance:", error);
      }
    }
  
    // Display semester attendance in a table
    function displaySemesterAttendance(data) {
      const container = document.getElementById('semesterAttendance');
      let html = `<table border="1" cellspacing="0" cellpadding="5">
                  <tr>
                    <th>Student ID</th>
                    <th>Subject</th>
                    <th>Count</th>
                    <th>Total Lectures</th>
                    <th>% Attendance</th>
                  </tr>`;
      data.forEach(student => {
        // If a student has multiple subjects, merge student ID cell.
        student.subjects.forEach((sub, index) => {
          html += '<tr>';
          if (index === 0) {
            html += `<td rowspan="${student.subjects.length}">${student.id}</td>`;
          }
          html += `<td>${sub.subject}</td>
                   <td>${sub.count}</td>
                   <td>${sub.totalLectures}</td>
                   <td>${sub.percent}</td>
                   </tr>`;
        });
      });
      html += '</table>';
      container.innerHTML = html;
    }
  
    // Display subject-wise attendance records
    function displaySubjectWiseAttendance(subjectWise) {
      const container = document.getElementById('subjectAttendance');
      let html = '';
      for (let subject in subjectWise) {
        html += `<h3>${subject}</h3>
                 <table border="1" cellspacing="0" cellpadding="5">
                 <tr>
                   <th>Student ID</th>
                   <th>Count</th>
                   <th>Total Lectures</th>
                   <th>% Attendance</th>
                 </tr>`;
        subjectWise[subject].forEach(record => {
          html += `<tr>
                     <td>${record.id}</td>
                     <td>${record.count}</td>
                     <td>${record.totalLectures}</td>
                     <td>${record.percent}</td>
                   </tr>`;
        });
        html += '</table>';
      }
      container.innerHTML = html;
    }
  
    // Display daily attendance records for the selected date
    function displayDailyAttendance(users) {
      const container = document.getElementById('dailyAttendance');
      let html = `<table border="1" cellspacing="0" cellpadding="5">
                  <tr>
                    <th>Student ID</th>
                    <th>Time Slot</th>
                    <th>Subject</th>
                  </tr>`;
      users.forEach(user => {
        for (let timeSlot in user.attendance) {
          html += `<tr>
                     <td>${user.uid}</td>
                     <td>${timeSlot}</td>
                     <td>${user.attendance[timeSlot]}</td>
                   </tr>`;
        }
      });
      html += '</table>';
      container.innerHTML = html;
    }
  </script>
</head>
<body>
  <h1>Attendance Report</h1>
  
  <!-- Daily Attendance Section -->
  <section>
    <h2>Daily Attendance</h2>
    <label for="dailyDate">Select Date: </label>
    <input type="date" id="dailyDate" value="2025-02-24"/>
    <button onclick="fetchDailyAttendance()">Fetch Daily Attendance</button>
    <div id="dailyAttendance"></div>
  </section>
  
  <!-- Semester Attendance Section -->
  <section>
    <h2>Semester Attendance Percentage</h2>
    <div id="semesterAttendance"></div>
  </section>
  
  <!-- Subject-wise Attendance Section -->
  <section>
    <h2>Subject-wise Attendance Records</h2>
    <div id="subjectAttendance"></div>
  </section>
</body>
</html>
