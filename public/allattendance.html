<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Report</title>
  <script>
    // On page load, fetch semester attendance data.
    window.onload = async function () {
      try {
        // Set default daily attendance date to today (YYYY-MM-DD)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dailyDate').value = today;

        // Fetch semester endpoints concurrently.
        const [attendanceSummary, lecturesData, subjectsData, uidsData] = await Promise.all([
          fetch('/node/users/attendance').then(res => res.json()),
          fetch('/node/lectures?start=2025-01-01&end=2025-03-24').then(res => res.json()),
          fetch('/node/subjects').then(res => res.json()),
          fetch('/node/fetch').then(res => res.json())
        ]);

        // Build a lookup for semester attendance.
        let attendanceMap = {};
        attendanceSummary.users.forEach(user => {
          attendanceMap[user._id] = {};
          user.subjects.forEach(sub => {
            attendanceMap[user._id][sub.subject] = sub.count;
          });
        });

        // Build semester attendance grid (students vs subjects).
        let semesterData = [];
        uidsData.uids.forEach(uid => {
          let row = { uid: uid, records: {} };
          subjectsData.subjects.forEach(subject => {
            const count = (attendanceMap[uid] && attendanceMap[uid][subject]) || 0;
            const totalLectures = lecturesData[subject] || 0;
            const percent = totalLectures > 0 ? ((count / totalLectures) * 100).toFixed(2) : "N/A";
            row.records[subject] = { count, totalLectures, percent };
          });
          semesterData.push(row);
        });

        displaySemesterAttendance(semesterData, subjectsData.subjects, lecturesData);
      } catch (error) {
        console.error("Error fetching semester data:", error);
      }
    };

    // Fetch daily attendance and timetable subjects based on the selected date.
    async function fetchDailyAttendance() {
      const date = document.getElementById('dailyDate').value;
      try {
        // Using proper query parameter format for today's subjects.
        const [dailyAttendanceResponse, todaySubjectsResponse, uidsResponse] = await Promise.all([
          fetch('/node/users/attendance/' + date).then(res => res.json()),
          fetch('/node/today-subjects?date=' + date).then(res => res.json()),
          fetch('/node/fetch').then(res => res.json())
        ]);

        // Build lookup: for each student, list subjects attended that day.
        let dailyLookup = {};
        dailyAttendanceResponse.users.forEach(user => {
          dailyLookup[user.uid] = [];
          for (let slot in user.attendance) {
            dailyLookup[user.uid].push(user.attendance[slot]);
          }
        });

        displayDailyAttendance(uidsResponse.uids, todaySubjectsResponse.subjects, dailyLookup);
      } catch (error) {
        console.error("Error fetching daily attendance:", error);
      }
    }

    // Display semester attendance grid: rows = students, columns = subjects.
    function displaySemesterAttendance(data, subjects, lecturesData) {
      let html = `<table border="1" cellspacing="0" cellpadding="5">
                    <tr>
                      <th>Student ID</th>`;
      subjects.forEach(subject => {
        const totalLectures = lecturesData[subject] || 0;
        html += `<th>${subject}<br>(Total: ${totalLectures})</th>`;
      });
      html += `</tr>`;
      data.forEach(row => {
        html += `<tr><td>${row.uid}</td>`;
        subjects.forEach(subject => {
          const rec = row.records[subject];
          html += `<td>${rec.count} / ${rec.totalLectures} (${rec.percent}%)</td>`;
        });
        html += '</tr>';
      });
      html += '</table>';
      document.getElementById('semesterAttendance').innerHTML = html;
    }

    // Display daily attendance grid: rows = students, columns = subjects from the day's timetable.
    function displayDailyAttendance(uids, subjects, dailyLookup) {
      let html = `<table border="1" cellspacing="0" cellpadding="5">
                    <tr>
                      <th>Student ID</th>`;
      subjects.forEach(subject => {
        html += `<th>${subject}</th>`;
      });
      html += `</tr>`;
      uids.forEach(uid => {
        html += `<tr><td>${uid}</td>`;
        subjects.forEach(subject => {
          // If a student attended the subject (in any timeslot), mark as Present.
          const attended = dailyLookup[uid] && dailyLookup[uid].includes(subject);
          html += `<td style="text-align: center; font-weight: bold; color: ${attended ? 'green' : 'red'}">
                    ${attended ? 'P' : 'A'}
                   </td>`;
        });
        html += '</tr>';
      });
      html += '</table>';
      document.getElementById('dailyAttendance').innerHTML = html;
    }
  </script>
</head>
<body>
  <h1>Attendance Report</h1>

  <!-- Daily Attendance Section -->
  <section>
    <h2>Daily Attendance</h2>
    <label for="dailyDate">Select Date: </label>
    <input type="date" id="dailyDate"/>
    <button onclick="fetchDailyAttendance()">Fetch Daily Attendance</button>
    <div id="dailyAttendance"></div>
  </section>

  <!-- Semester Attendance Section -->
  <section>
    <h2>Semester Attendance Percentage (Student vs Subject)</h2>
    <div id="semesterAttendance"></div>
  </section>
</body>
</html>
